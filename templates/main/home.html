{% extends 'base.html' %}

{% block title %}Upload Chat - StudyMate{% endblock %}

{% block content %}
<div class="container">
    <div class="upload-section">
        <h1>StudyMate</h1>
        <p class="subtitle">Organize your AI chat sessions into indexed, searchable Q&A pairs</p>

        <div class="method-tabs">
            <button class="tab-btn active" onclick="showTab('scraper')">Use Scraper (Recommended)</button>
            <button class="tab-btn" onclick="showTab('paste')">Quick Paste</button>
        </div>

        <!-- Scraper Method -->
        <div id="scraper-tab" class="tab-content active">
            <div class="scraper-instructions">
                <h3>How to Export Your Chat</h3>
                <p>Works with <strong>Claude</strong>, <strong>ChatGPT</strong>, and <strong>Gemini</strong></p>

                <div class="steps">
                    <div class="step">
                        <span class="step-number">1</span>
                        <div class="step-content">
                            <strong>Open your chat</strong>
                            <p>Go to your conversation on claude.ai, chatgpt.com, or gemini.google.com</p>
                        </div>
                    </div>

                    <div class="step">
                        <span class="step-number">2</span>
                        <div class="step-content">
                            <strong>Open Developer Console</strong>
                            <p>Press <kbd>F12</kbd> or <kbd>Ctrl+Shift+J</kbd> (Mac: <kbd>Cmd+Option+J</kbd>)</p>
                        </div>
                    </div>

                    <div class="step">
                        <span class="step-number">3</span>
                        <div class="step-content">
                            <strong>Copy & Run the Script</strong>
                            <p>Copy the script below and paste it into the Console tab, then press Enter</p>
                        </div>
                    </div>

                    <div class="step">
                        <span class="step-number">4</span>
                        <div class="step-content">
                            <strong>Paste the Result</strong>
                            <p>The JSON data is copied to your clipboard - paste it below!</p>
                        </div>
                    </div>
                </div>

                <div class="script-box">
                    <div class="script-header">
                        <span>Scraper Script</span>
                        <button onclick="copyScript()" class="copy-btn">Copy Script</button>
                    </div>
                    <pre id="scraper-script">{% include "main/scraper_script.html" %}</pre>
                </div>
            </div>
        </div>

        <!-- Quick Paste Method -->
        <div id="paste-tab" class="tab-content">
            <div class="paste-info">
                <p><strong>Note:</strong> Quick paste may not parse perfectly. For best results, use the scraper method above.</p>
            </div>
        </div>

        <!-- Upload Form (shown for both methods) -->
        <form method="post" action="{% url 'upload' %}" class="upload-form">
            {% csrf_token %}

            <div class="form-group">
                <label for="title">Title (optional)</label>
                <input type="text" id="title" name="title" placeholder="e.g., Machine Learning Study Session">
            </div>

            <div class="form-group">
                <label for="content">Chat Content (JSON or plain text)</label>
                <textarea
                    id="content"
                    name="content"
                    rows="12"
                    placeholder="Paste the exported JSON from the scraper here, or paste plain text..."
                    required
                ></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Upload & Process</button>
        </form>
    </div>

    {% if recent_documents %}
    <div class="recent-section">
        <h2>Recent Uploads</h2>
        <ul class="document-list">
            {% for doc in recent_documents %}
            <li>
                <a href="{% url 'document_detail' doc.id %}">
                    <span class="doc-title">{{ doc.title|default:"Untitled Chat" }}</span>
                    <span class="doc-meta">{{ doc.session_count }} sessions - {{ doc.uploaded_at|date:"M d, Y H:i" }}</span>
                    <span class="doc-status status-{{ doc.status }}">{{ doc.get_status_display }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
}

function copyScript() {
    const script = document.getElementById('scraper-script').textContent;
    navigator.clipboard.writeText(script).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => {
            btn.textContent = 'Copy Script';
        }, 2000);
    });
}
</script>
{% endblock %}
